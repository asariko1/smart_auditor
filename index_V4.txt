<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Smart Schedule Auditor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background: #f8f9fa; color: #333; margin: 0; }
        /* Create a side-by-side layout */
        .app-container { display: flex; flex-direction: row; gap: 20px; max-width: 1200px; margin: auto; align-items: flex-start; }
        
        /* Main Audit Tool Panel */
        .main-panel { flex: 2; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h2 { margin-top: 0; color: #1a1a1a; }
        .input-group { margin-bottom: 25px; }
        .input-group label { font-weight: bold; font-size: 14px; display: block; margin-bottom: 8px; }
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-family: monospace; }
        .drop-zone { border: 2px dashed #007bff; padding: 25px; text-align: center; margin-bottom: 15px; border-radius: 8px; cursor: pointer; transition: 0.2s; background: #fafcff; }
        .drop-zone:hover { background: #e6f0ff; border-color: #0056b3; }
        button { width: 100%; padding: 16px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600; margin-top: 10px; transition: 0.2s; }
        button:hover { background: #0056b3; }
        #output { margin-top: 20px; white-space: pre-wrap; background: #f1f3f5; padding: 20px; border-radius: 8px; line-height: 1.6; border: 1px solid #e9ecef; }
        .file-name { font-size: 0.85em; color: #555; margin-top: 8px; font-weight: bold; }

        /* System Console Panel */
        .console-panel { flex: 1; background: #1e1e1e; color: #e0e0e0; padding: 20px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.2); font-family: monospace; position: sticky; top: 20px; }
        .console-panel h3 { margin-top: 0; color: #00ffcc; border-bottom: 1px solid #333; padding-bottom: 10px; font-size: 16px; }
        #systemLog { list-style: none; padding: 0; margin: 0; font-size: 13px; line-height: 1.5; }
        #systemLog li { margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px dashed #333; }
        .log-time { color: #888; font-size: 11px; margin-right: 5px; }
        .status-ok { color: #00ff00; font-weight: bold; }
        .status-error { color: #ff4444; font-weight: bold; }
	  .token-count { color: #00ccff; font-weight: bold; border-bottom: 1px solid #00ccff; padding-bottom: 2px; }
        .status-wait { color: #ffaa00; font-weight: bold; }
        
        /* Mobile responsiveness */
        @media (max-width: 800px) {
            .app-container { flex-direction: column; }
            .console-panel { width: 100%; box-sizing: border-box; }
        }
    </style>
</head>
<body>

<div class="app-container">
    <div class="main-panel">
        <h2>Smart Schedule Auditor</h2>
        <p>Compare Excel schedules against the Master PDF (Page 2).</p>

        <div class="input-group">
            <label>Gemini API Key</label>
            <input type="text" id="apiKey" placeholder="Paste your API Key here...">
        </div>
        
        <div class="drop-zone" onclick="document.getElementById('excelFile').click()">
            <strong>1. Upload Excel/CSV File</strong>
            <input type="file" id="excelFile" hidden accept=".xlsx, .csv">
            <div id="excelName" class="file-name">No file selected</div>
        </div>

        <div class="drop-zone" onclick="document.getElementById('pdfFile').click()">
            <strong>2. Upload Master PDF (.pdf)</strong>
            <input type="file" id="pdfFile" hidden accept=".pdf">
            <div id="pdfName" class="file-name">No file selected</div>
        </div>

        <button id="runBtn">Run Audit</button>

        <div id="output">Results will appear here...</div>
    </div>

    <div class="console-panel">
        <h3>System Console</h3>
        <ul id="systemLog">
            <li><span class="log-time">System</span> Ready for input.</li>
        </ul>
    </div>
</div>

<script>
    let excelText = "";
    let pdfText = "";
    let isExcelReady = false;
    let isPdfReady = false;
    
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // Helper function to write to our visual console
    // Code flows top to bottom

    function logToConsole(message, statusText, statusClass) {
        const ul = document.getElementById('systemLog');
        const li = document.createElement('li');
        const time = new Date().toLocaleTimeString();
        li.innerHTML = `<span class="log-time">[${time}]</span> ${message} <span class="${statusClass}">[${statusText}]</span>`;
        
        // Change: This adds the log to the BOTTOM of the list
        ul.appendChild(li);

        // Optional: Auto-scroll the console to the bottom so you see Stage 6 immediately
        const consolePanel = document.querySelector('.console-panel');
        consolePanel.scrollTop = consolePanel.scrollHeight;
    }

    // 1. Excel Parsing
    document.getElementById('excelFile').onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    document.getElementById('excelName').innerText = "Processing: " + file.name;
    logToConsole(`Reading ${file.name}...`, "WAITING", "status-wait");

    const reader = new FileReader();
    reader.onload = (event) => {
        const data = new Uint8Array(event.target.result);
        const wb = XLSX.read(data, { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        excelText = XLSX.utils.sheet_to_txt(ws);
        isExcelReady = true;
        document.getElementById('excelName').innerText = "Ready: " + file.name;
        logToConsole("Excel Data Extracted", "OK", "status-ok");

        // ðŸ”¹ Reset input to allow re-uploading same file
        document.getElementById('excelFile').value = null;
    };
    reader.readAsArrayBuffer(file);
};

    // 2. PDF Parsing
    document.getElementById('pdfFile').onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    document.getElementById('pdfName').innerText = "Processing: " + file.name;
    logToConsole(`Reading ${file.name}...`, "WAITING", "status-wait");

    const reader = new FileReader();
    reader.onload = async (event) => {
        try {
            const typedarray = new Uint8Array(event.target.result);
            const pdf = await pdfjsLib.getDocument(typedarray).promise;
            let text = "";
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const content = await page.getTextContent();
                text += content.items.map(item => item.str).join(" ");
            }
            pdfText = text;
            isPdfReady = true;
            document.getElementById('pdfName').innerText = "Ready: " + file.name;
            logToConsole("PDF Text Extracted", "OK", "status-ok");

            // ðŸ”¹ Reset input to allow re-uploading same file
            document.getElementById('pdfFile').value = null;
        } catch (err) {
            logToConsole(`PDF Error: ${err.message}`, "ERROR", "status-error");
        }
    };
    reader.readAsArrayBuffer(file);
};


    // Error Logging Console.


    document.getElementById('runBtn').onclick = async () => {
    const key = document.getElementById('apiKey').value.trim();
    const outputDiv = document.getElementById('output');
    
    // Clear previous logs and output for a fresh start
    document.getElementById('systemLog').innerHTML = "";
    outputDiv.innerText = "";

    // 1 VALIDATE
    logToConsole("STAGE 1: Validating Credentials & Files...", "WAIT", "status-wait");
    if (!key) {
        logToConsole("Validation Failed: API Key missing", "ERROR", "status-error");
        return alert("Please enter your API Key.");
    }
    if (!isExcelReady || !isPdfReady) {
        logToConsole("Validation Failed: Files not processed", "ERROR", "status-error");
        return alert("Please upload both files first.");
    }
    logToConsole("Validation Successful", "OK", "status-ok");

    // 2 PREPARE PROMPT
    logToConsole("STAGE 2: Preparing Data for Gemini...", "WAIT", "status-wait");
    const prompt = `Professional Audit: PDF is source of truth. Compare to Excel Markdown list.
PDF DATA: ${pdfText}
EXCEL DATA: ${excelText}
INSTRUCTIONS:
1. Convert 24h Excel times to 12h PDF times.
2. Match Venues logically (e.g. Poolside = Pool Deck).
3. Report MISSING activities, TIME mismatches, and VENUE mismatches.`;
    logToConsole("Prompt Payload Constructed", "OK", "status-ok");

    // 3 SEND REQUEST
    logToConsole("STAGE 3: Sending Request to Google API...", "WAIT", "status-ok");
    try {
        const response = await fetch(
            `https://generativelanguage.googleapis.com/v1beta/models/gemini-3-flash-preview:generateContent?key=${key}`,
            {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: { temperature: 0.1 }
                })
            }
        );

        // 4 AWAIT RESPONSE
        logToConsole("STAGE 4: Awaiting AI Generation...", "WAITING", "status-wait");
        
        if (!response.ok) {
            const statusCode = response.status;
            const rawBody = await response.text(); 
            let errorMessage = rawBody || "Unknown API Error";
            try {
                const errorData = JSON.parse(rawBody);
                errorMessage = errorData?.error?.message || errorMessage;
            } catch (e) {}
            logToConsole(`Google API Error ${statusCode}`, "REJECTED", "status-error");
            throw new Error(`[Code ${statusCode}] ${errorMessage}`);
        }

        const result = await response.json();
        logToConsole("Response Received from Google", "OK", "status-ok");

        // 5 PROCESS RESULTS
        logToConsole("STAGE 5: Processing Results...", "WAIT", "status-wait");
        if (result.usageMetadata) {
            const promptTokens = result.usageMetadata.promptTokenCount || 0;
            const candidateTokens = result.usageMetadata.candidatesTokenCount || 0;
            const totalTokens = promptTokens + candidateTokens;
            const totalCost = (((promptTokens / 1000000) * 0.50) + ((candidateTokens / 1000000) * 3.00)).toFixed(5);

            logToConsole(
                `Usage: ${totalTokens} tokens (In: ${promptTokens} | Out: ${candidateTokens})`,
                `Est. Cost: $${totalCost}`,
                "token-count"
            );
        }

        // 6 COMPLETE
        if (result.candidates && result.candidates[0].content && result.candidates[0].content.parts[0].text) {
            outputDiv.innerText = result.candidates[0].content.parts[0].text;
            logToConsole("STAGE 6: Audit Complete", "SUCCESS", "status-ok");
        } else {
            throw new Error("AI returned an empty response.");
        }

    } catch (err) {
        logToConsole("Audit Lifecycle Interrupted", "CRASHED", "status-error");
        logToConsole(err.message, "DETAILS", "status-error");
        outputDiv.innerText = "Error: " + err.message;
    }
};
</script>

</body>
</html>